---
title: "SeminarioAguaYEnfemedadesRenales"
author: "Samuel Espiño Encinas, Lydia Ortiz Hernando y María García Paredes"
date: "2025-11-23"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
---
<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


* [Repositorio de GitHub](https://github.com/mgp1046/SEMINARIO_FUENTES_GRUPO_I.git)


## **Introducción**

Las enfermedades renales crónicas representan un problema de salud pública con un impacto creciente en Europa.  
Al mismo tiempo, la calidad del agua puede verse afectada por diversos factores:

- contaminación agrícola,  
- vertidos urbanos e industriales,  
- presiones difusas,  
- sustancias peligrosas,  
- degradación ecológica de los ríos y embalses.

La combinación de ambos dominios —medio ambiente y salud— permite estudiar si existe algún tipo de relación que pueda ser relevante para la prevención y gestión sanitaria.


## **Objetivos**

El objetivo principal de este seminario es analizar la posible relación entre:

- el **estado ecológico de las masas de agua superficiales** de Europa, y  
- la **incidencia de enfermedades renales** registradas en distintos países europeos.

Para ello combinamos información procedente de bases de datos ambientales y sanitarias oficiales de la Unión Europea. Nuestro propósito es detectar patrones, correlaciones y tendencias que ayuden a comprender si la calidad del agua podría tener algún impacto sobre la salud renal de la población.


## **Limitaciones del estudio**

El presente análisis presenta diversas limitaciones que deben tenerse en cuenta al interpretar los resultados obtenidos:

1. **Disponibilidad y heterogeneidad de los datos**  
   Los datos procedentes de Eurostat y de la European Environment Agency (EEA) no siempre están armonizados en cuanto a años disponibles, unidades de medida o detalle territorial. Esto obliga a realizar filtrados y condensaciones que pueden reducir la precisión del análisis.

2. **Falta de sincronía temporal**  
   Los años de referencia para las enfermedades renales y para la calidad del agua no coinciden necesariamente entre países. Esta falta de alineación temporal dificulta el establecimiento de relaciones causales o de tendencias comparables.

3. **Simplificación de indicadores ambientales**  
   Los indicadores de calidad del agua empleados (estado químico y ecológico) representan resúmenes generales y no capturan la complejidad completa del ecosistema acuático ni la variabilidad espacial dentro de cada país. Además, algunos países presentan valores incompletos o categorizados de forma distinta.

4. **Variables no consideradas**  
   Las enfermedades renales pueden depender de factores socioeconómicos, genéticos, alimentarios o sanitarios que no se incluyen en este análisis. La ausencia de estas variables relevantes implica que las correlaciones observadas pueden estar influenciadas por elementos externos no medidos.

5. **Interpretación limitada por la agregación de datos**  
   Tanto los datos ambientales como los sanitarios se agregan a nivel nacional. Esto puede ocultar patrones regionales importantes y generar resultados demasiado generalizados para extraer conclusiones sólidas a nivel local.

6. **Representatividad de las masas de agua**  
   Los estados ecológico y químico provienen de masas de agua superficiales (ríos, lagos y embalses), pero estas no necesariamente corresponden a las fuentes principales de agua de consumo humano en cada país, lo cual limita la interpretación directa en términos de salud pública..

En conjunto, estas limitaciones indican que los resultados deben interpretarse con cautela. El estudio permite explorar patrones generales, pero no establecer relaciones causales firmes entre calidad del agua y enfermedades renales sin un análisis más detallado y con datos más completos.


## **Metodología**

Los datos utilizados en este seminario provienen de dos fuentes oficiales europeas. Por un lado, los datos médicos proceden de Eurostat, accesibles mediante API.

Por otro lado, los datos medioambientales se han obtenido de la European Environment Agency (EEA) a través de su portal Data and Maps, donde pueden descargarse en formatos CSV, TSV, JSON y GeoJSON. 
Estos archivos se encuentran organizados dentro de la carpeta Data del repositorio para su posterior tratamiento en R.

Para poder utilizar estos conjuntos de datos y poder importarlos, utilizaremos las siguientes librerías:

```{r , eval = TRUE,message=FALSE, warning=FALSE}
library(eurostat)
library(xml2)
library(rjson)
library(dplyr)
library(ggplot2)
library(tidyr)
library(jsonlite)
library(furrr)
library(purrr)
library(future.apply)
library(plotly)
```


### **Importación archivos**

Con todas las librerías cargadas ya podemos importar los datos.


### Importación datos Eurostat:
Importamos desde Eurostat un conjunto de datos oficiales sobre enfermedades renales, descargado automáticamente mediante su API. La función obtiene el dataset identificado como el segundo resultado relacionado con “renal” y lo carga en formato dataframe listo para analizar.

```{r , eval = TRUE,message=FALSE}
datos_nef_valores <- get_eurostat(search_eurostat("renal")[2], lang = "en")

```


### Preparación datos Eurostat

Una vez obtenidos los datos y pudiendo ver su estructura, los modificaremos y ordenaremos de modo que sea más sencillo su manejo y comprensión.

El objetivo de este bloque de datos es conseguir que los años (TIME_PERIOD), que de forma predeterminada vienen en una única columna (date), estén correctamente formateados como valores numéricos y se puedan utilizar como variable temporal. Además, se renombran las columnas para que tengan nombres claros (icd9cm a enfermedades) y se eliminan columnas innecesarias (freq). Todo esto permite tener un dataframe limpio y estructurado, con cada registro asociado a un país y a un año, listo para su análisis.

```{r , eval = TRUE,message=FALSE}
#Eliminamos la columna freq, que solo tiene un nivel que se repite constantemente
datos_nef_valores$freq <- NULL

#Cambiamos el nombre a la columna icd9cm
datos_nef_valores <- datos_nef_valores %>%
  rename(enfermedades = icd9cm)

#Cambiamos el nombre a la columna TIME_PERIOD
datos_nef_valores <- datos_nef_valores %>% 
  rename(date = TIME_PERIOD)

#Cambiamos formato de fecha
datos_nef_valores$date <- format(as.Date(datos_nef_valores$date), "%Y")

#Convertimos date a numeric
datos_nef_valores$date <- as.numeric(datos_nef_valores$date)


datos_nef_codigos <- get_eurostat(search_eurostat("renal")[2], lang = "en", type = "label")
datos_nef_codigos$freq <- NULL

datos_nef_codigos <- datos_nef_codigos %>%
  rename(enfermedades = icd9cm)

datos_nef_codigos <- datos_nef_codigos %>% 
  rename(date = TIME_PERIOD)

datos_nef_codigos$date <- format(as.Date(datos_nef_codigos$date), "%Y")

datos_nef_codigos$date <- as.numeric(datos_nef_codigos$date)

#Visualización de estructura
str(datos_nef_valores)
str(datos_nef_codigos)
```


### **Importación datos JSON:**

Importamos los datos de calidad del agua desde un archivo GeoJSON y los convertimos en un dataframe limpio y manejable en R. Primero, se leen todas las features del archivo, y para cada una se extraen sus propiedades (properties). Se reemplazan los valores NULL por NA para evitar problemas en el análisis y se convierten las listas resultantes en dataframes individuales. Finalmente, todos estos dataframes se combinan en un único dataframe (agua_data) que contiene todos los registros y atributos de interés, listo para ser filtrado, renombrado y analizado.

```{r , eval = TRUE,message=FALSE}
agua_data <- jsonlite::fromJSON("Data/DataExtract.geojson", simplifyVector = FALSE)
  

agua_data <- lapply(agua_data$features, function(feature){
    pro <- feature$properties
    
    pro <- lapply(pro, function(x) if (is.null(x)) NA else x)
    
    as.data.frame(pro, stringAsFactor = FALSE)
  }) %>%
  bind_rows(.) 
```


### Preparación archivos .json

En este bloque se seleccionan únicamente las columnas que son relevantes para nuestro análisis de calidad del agua, eliminando información innecesaria. Posteriormente, se renombra la columna cArea como "Area_(km2)" para reflejar claramente que representa la superficie en kilómetros cuadrados. Finalmente, se filtran los registros eliminando las masas de agua costera ("CW") y las de agua marítima territorial ("TeW"), ya que no son tipos de agua potable, por lo que interfieren en nuestro análisis.

```{r , eval = TRUE,message=FALSE}
agua_data <- select(agua_data, cYear, countryCode, fileUrl, euRBDCode, rbdName, euSubUnitCode, surfaceWaterBodyName, cArea, surfaceWaterBodyCategory,
         reservoir, hasDescriptiveData, swEcologicalStatusOrPotentialValue, swChemicalStatusValue) %>%
  dplyr::rename(., "Area_(km2)" = cArea) %>%
  filter(!surfaceWaterBodyCategory %in% c("CW", "TeW"))


#Visualización de estructura
str(agua_data)
colnames(agua_data)
```

Además, debido a la gran carga de datos y el tiempo de ejecución que supone, lo guardamos exportamos para optimizar el código.

```{r , eval = TRUE,message=FALSE}
# Guardamos el objeto de R para que en futuras ejecuciones no tarde tanto
saveRDS(object = agua_data, file = "Data/Datos_calidad_agua.rds")

# Carga de los datos SIN EJECUTAR TODO

agua_data <- readRDS(file = "Data/Datos_calidad_agua.rds")
```


### **Inspección de datos**

Realizamos diversas comprobaciones y uniones para ver qué datos geográficos podemos utilizar como punto de unión para el análisis, y así poder compararlos con los datos del agua.

```{r , eval = TRUE,message=FALSE}

#COMPARACION DE PAISES ENTRE AMBAS BASES DE DATOS 

#Vemos que paises tenemos en cada base de datos

unique(agua_data$countryCode)
unique(datos_nef_valores$geo)

paises_agua   <- unique(agua_data$countryCode)
paises_nefro  <- unique(datos_nef_valores$geo)

#Hacemos la interseccion para ver cuales son comunes
paises_comunes <- intersect(paises_agua, paises_nefro)
paises_comunes


#Filtramos SOLO los países comunes
agua_data <- agua_data %>% filter(countryCode %in% paises_comunes) 
datos_nef_valores <- datos_nef_valores %>% filter(geo %in% paises_comunes)
str(datos_nef_valores)
str(agua_data)


# Unión 
datos_combinados <- right_join(agua_data, datos_nef_valores, 
            by = c("countryCode" = "geo"))

str(datos_combinados)

#Resumen datos de agua por país
agua_resumen <- agua_data %>%
  group_by(countryCode) %>%
  summarise(
    Area_total = sum(`Area_(km2)`, na.rm = TRUE),
    swEcologicalStatus_promedio = mean(
      as.numeric(swEcologicalStatusOrPotentialValue[grepl("^[0-9]+$", swEcologicalStatusOrPotentialValue)]),
      na.rm = TRUE
    ),
    swChemicalStatus_promedio = mean(
      as.numeric(swChemicalStatusValue[grepl("^[0-9]+$", swChemicalStatusValue)]),
      na.rm = TRUE
    )
  )

#Resumen datos renales por país
nefro_resumen <- datos_nef_valores %>%
  group_by(geo) %>%
  summarise(total_casos_renales = sum(values, na.rm = TRUE))

#Unión final de los datos resumidos
datos_combinados_final <- agua_resumen %>%
  full_join(nefro_resumen, by = c("countryCode" = "geo"))
str(datos_combinados_final)
View(datos_combinados_final)
```


### **Estado químico y ecológico del agua VS casos renales por país**
Mediante el uso de diferentes visualizaciones, analizaremos cómo varían las características del agua en cada país y evaluaremos si dichos cambios pueden estar relacionados con un mayor riesgo de desarrollar enfermedades renales. A través de estas gráficas podremos observar patrones, tendencias y posibles asociaciones entre la calidad del agua y la incidencia de casos renales, lo que nos permitirá comprender mejor la influencia del entorno hídrico en la salud de la población.


### Estado químico VS casos renales

```{r , eval = TRUE,message=FALSE}
#Casos renales vs estado ecológico del agua
ggplot(datos_combinados_final, aes(x = swEcologicalStatus_promedio, y = total_casos_renales)) +
  geom_point(aes(size = Area_total, color = countryCode)) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  geom_smooth(method = "loess", se = TRUE, color = "red") +
  labs(
    x = "Estado ecológico promedio del agua",
    y = "Total de casos renales",
    size = "Área total (km2)",
    color = "País"
  ) +
  theme_minimal()
```

En este gráfico, la relación lineal entre el estado químico del agua y la tasa de casos renales por 100 mil habitantes es débil y ligeramente negativa. Esto indica que, en promedio, mejorar el estado químico del agua no se asocia de forma clara con una reducción de enfermedades renales, al menos no bajo un supuesto estrictamente lineal.

La curva LOESS vuelve a mostrar una forma en U, más marcada que en el gráfico del estado ecológico: las tasas más bajas de casos renales aparecen en niveles intermedios del estado químico, mientras que los valores extremos (muy pobres o muy buenos) muestran incrementos en la enfermedad renal. Esta relación no lineal sugiere que los extremos del estado químico podrían estar capturando condiciones específicas de ciertos países, posibles factores no controlados en el análisis o por poca densidad de datos en los extremos del eje.


### Estado ecológico VS casos renales
```{r , eval = TRUE,message=FALSE}
#Casos renales vs estado químico del agua
ggplot(datos_combinados_final, aes(x = swChemicalStatus_promedio, y = total_casos_renales)) +
  geom_point(aes(size = Area_total, color = countryCode)) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  geom_smooth(method = "loess", se = TRUE, color = "red") +
  
  labs(
    x = "Estado químico promedio del agua",
    y = "Total de casos renales",
    size = "Área total (km2)",
    color = "País"
 ) +
  theme_minimal()
```

El gráfico muestra que no existe una relación lineal fuerte entre el estado ecológico del agua y la tasa de casos renales por 100 mil habitantes. La pendiente del ajuste lineal es ligeramente negativa, lo que sugiere una tendencia muy débil hacia menos casos cuando el estado ecológico mejora. Sin embargo, la variabilidad entre países sigue siendo grande y no se observa un patrón simple que explique los valores más altos de enfermedades renales.

La curva LOESS revela una relación no lineal con forma de U, donde los valores intermedios del estado ecológico del agua (aprox. 2.4–2.6) se asocian con las tasas más bajas de casos renales, mientras que tanto los niveles muy bajos como los muy altos se relacionan con tasas mayores. Como en el caso anterior, puede deberse a diversas causas no relacionadas con el análisis principal.

### Estado ecológico y químico VS casos renales

```{r , eval = TRUE,message=FALSE}
#GRÁFICO ESTADO QUÍMICO Y ECOLÓGICO VS CASOS RENALES.
# Crear el gráfico de burbujas
p <- ggplot(datos_combinados_final, aes(
  x = swChemicalStatus_promedio,       # eje x = estado químico
  y = swEcologicalStatus_promedio,     # eje y = estado ecológico
  size = total_casos_renales,          # tamaño = casos renales
  color = swChemicalStatus_promedio,   # color opcional
  text = paste(
    "<b>", countryCode, "</b><br>",
    "Casos renales: ", total_casos_renales, "<br>",
    "Estado ecológico: ", round(swEcologicalStatus_promedio,2), "<br>",
    "Estado químico: ", round(swChemicalStatus_promedio,2)
  )
)) +
  geom_point(alpha = 0.8) +
  scale_size_continuous(range = c(5, 25)) + # Ajusta según la magnitud de los datos
  scale_color_viridis_c(option = "plasma", na.value = "lightgrey") +
  theme_minimal() +
  labs(
    x = "Estado químico",
    y = "Estado ecológico",
    size = "Casos renales",
    color = "Estado químico"
  )

# Convertir a interactivo
p_interactivo <- ggplotly(p, tooltip = "text")

p_interactivo
```

En este caso podemos ver los datos analizados anteriormente con más precisión, pero de una forma más interactiva y visual para el análisis.

```{r , eval = TRUE,message=FALSE}
#GRÁFICO ESTADO QUÍMICO Y ECOLÓGICO VS CASOS RENALES

# Seleccionar solo las columnas numéricas relevantes
datos_corr <- datos_combinados_final %>%
  select(
    swEcologicalStatus_promedio,
    swChemicalStatus_promedio,
    Area_total,
    total_casos_renales
  )

# Calcular matriz de correlaciones
matriz_corr <- round(cor(datos_corr, use = "pairwise.complete.obs"), 2)

# Pasamos a formato largo
matriz_corr_long <- as.data.frame(matriz_corr) %>%
  mutate(Var1 = rownames(.)) %>%
  pivot_longer(-Var1, names_to = "Var2", values_to = "Correlacion")

# Heatmap
ggplot(matriz_corr_long, aes(x = Var1, y = Var2, fill = Correlacion)) +
  geom_tile(color = "white") +
  geom_text(aes(label = Correlacion), color = "black", size = 5) +
  scale_fill_viridis_c(option = "plasma", limits = c(-1,1)) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title = element_blank(),
    panel.grid = element_blank()
  ) +
  labs(
    fill = "Correlación",
    title = "Heatmap de correlaciones entre calidad del agua y casos renales"
  )
```

Finalmente, en este último gráfico podemos observar los valores de forma numérica. Este análisis de correlaciones confirma que, en este conjunto de datos, no existe una relación lineal significativa entre la calidad del agua y la carga de enfermedad renal por país. Tanto el estado ecológico como el químico muestran correlaciones cercanas a cero con los casos renales (-0.03 y -0.09), lo que indica ausencia de asociación lineal detectable. Del mismo modo, el área total de cada país tampoco guarda relación con la enfermedad renal (-0.02), descartando que el tamaño territorial influya en los resultados. La única correlación relevante es la moderada relación entre la calidad ecológica y química del agua (0.54), algo esperable dado que ambos indicadores suelen mejorar o deteriorarse conjuntamente. En conjunto, el gráfico sugiere que la calidad del agua, medida de forma lineal y agregada a nivel país, no explica las variaciones en la tasa de enfermedad renal —lo que apunta a que otros factores demográficos, socioeconómicos o ambientales podrían estar desempeñando un papel más importante.


### **Conclusiones**
Tras el análisis detallado de los datos y la observación de las gráficas proporcionadas, se puede inferir que, en el contexto de los países europeos, la calidad del agua no parece tener un impacto significativo en la incidencia de enfermedades renales. Esto sugiere que otros factores, posiblemente relacionados con hábitos de vida, genética, atención médica o condiciones socioeconómicas, podrían desempeñar un papel más determinante en la aparición de estas patologías. Por lo tanto, aunque la calidad del agua sigue siendo un aspecto importante para la salud pública en general, en este caso específico no se observa una relación directa y significativa con los problemas renales.


### **Referencias**

- **European Environment Agency (EEA).** *Data and Maps.*  
  Disponible en: https://www.eea.europa.eu/en/datahub

- **Eurostat.** *Health Status – Disease Statistics.*  
  Disponible en: https://ec.europa.eu/eurostat/web/health/data/database

- **Eurostat API – Paquetes en R.**  
  Documentación y acceso mediante el paquete **eurostat**:  
  https://ropengov.github.io/eurostat/

- **R Graph Gallery.** *Bubble map with ggplot2.*  
  Disponible en: https://r-graph-gallery.com/330-bubble-map-with-ggplot2.html

- **Paquete jsonlite.** *Reading and parsing JSON in R.*  
  Documentación: https://cran.r-project.org/web/packages/jsonlite/vignettes/json-mapping.pdf

- **Paquete ggplot2.** Wickham, H. (2016). *ggplot2: Elegant Graphics for Data Analysis.* Springer.  
  Documentación: https://ggplot2.tidyverse.org/

- **Paquete dplyr.** Wickham, H., et al. *dplyr: A Grammar of Data Manipulation.*  
  Documentación: https://dplyr.tidyverse.org/

- **Paquete plotly.**  
  Documentación: https://plotly-r.com/
